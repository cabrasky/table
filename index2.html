<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <meta name="author" content="Cabrasky">
</head>
<body>
    <div id="table_frame">

    </div>
    <style>

        *{
            padding: 0;
            margin: 0;
        }
        .table {
            display: block;
            max-width: -moz-fit-content;
            max-width: fit-content;
            overflow: hidden;
            white-space: nowrap;
            font-size: 0;
        }
        .dCell, .hCell{
            position: relative;
            display: block;
            font-size: 20px;
            overflow: hidden;
            top: 0px;
            border: 0px solid black;
            height: 25px;
        }
        .hCell{
            border: 1px solid black;
            background-color: #f1f1f1;
        }
        .hCell > p{
            display: inline-block;
        }
        .col{
            display: inline-block;
            background-color: #ffffff;
        }
        .col:first-child{
            margin-left: 0px;
        }
        .rows > .dCell:nth-child(even){
            background-color: #f9f9f9;
        }
        .innerCol{
            display: inline-block;
            width: calc(100% - 5px)
        }
        .col:last-child .innerCol{
            width: calc(100% - 2.5px);
        }
        .hResize{
            width: 5px;
            position: relative;
            top: 0px;
            display: flex;
            float: right;
            cursor:col-resize;
            user-select: none;
            background: white;
            color: white;
        }
        .col:last-child .hResize{
            width: 2.5px;
            
        }
        #tableSlider{
            width: 100%;
            height: 10px;
            background-color: wheat;
        }
        .tableSliderBar{
            position: relative;
            height: 8px;
            margin-top: 1px;
            background-color: black;
        }
        .d_data {
            display: inline-block;
        }
        input.d_data{
            width: 100%;
        }
        .hCell:hover > .sort > .sort_arrow{
            display: block;
        }
        .sort{
            height: 100%;
            width: 20px;
            float: right;
        }
        .sort > .sort_arrow{
            height: 50%;
            display: none;
            text-align: center;
            font-size: 20px;
            color: grey;
        }
        .sort_used > .sort > *{
            display: block;
        }
        .sort_up_arrow {
            margin-top: -7.5px;
        }
        .sort_down_arrow {
            margin-top: -5px;
        }
        .sort_arrow_used{
            color: black !important;
        }
        .clicker {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            position:absolute;
        }
        .search_bar {
            width: 100%;
            height: 2rem;
            display: none;
        }
        .search_bar.visible{
            display: block;
        }
        .invisible{
            display: none;
        }
        .search_bar_input{
            width: 90%;
            height: 1rem;
            margin: .5rem 5%;
        }
        .mag_glass{
            height: 34px;
            width: 34px;
            background-color: cadetblue;
        }
        .mag_glass > *{
            margin: 7px;
            height: 20px;
            width: 20px;
        }
    </style>
    
</body>
<script>
    var beenClicked = undefined
    var min_width = 30
    class table {
        constructor(options){
            this.headers_data = []
            this.rows_data = []
            this.rows_data_filtered = []
            this.node = document.createElement('div')
            this.node.classList.add("table")
            this.resizers = []
            this.sortedDirection = "up"
            if(options.data_handeler){
                this.data_handeler = options.data_handeler
            }
            this.search_button = document.createElement("div")
            this.search_button.classList.add("mag_glass")
            this.search_button.innerHTML = `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><path fill="#231F20" d="m486.8,418.5l-152.6-152.6c-4.1-4.1-10.7-4.1-14.7,0l-19.5,19.4-36.3-36.3c21.8-25.2 35-58.1 35-94.1 0-79.4-64.4-143.8-143.8-143.8s-143.9,64.4-143.9,143.8 64.4,143.8 143.8,143.8c36,0 68.9-13.2 94.1-35l36.3,36.3-19.4,19.4c-5.9,6.6-2,12.8 0,14.7l152.6,152.6c27.3,25.2 57.1,11.2 68.3,0 25-24.7 12.7-55.6 0.1-68.2zm-331.9-140.6c-67.9,0-123-55.1-123-123 0-67.9 55.1-123 123-123s123,55.1 123,123c0,67.9-55.1,123-123,123zm317.2,194.2c-10.7,10.7-28.1,10.7-38.8,0l-145.3-145.3 38.8-38.8 145.3,145.2c15.4,16.8 5.3,33.5 0,38.9z"/></g></svg>`
            this.search_button.parentTable = this
            this.searching = false
            this.filtered = false
            this.search_button.onclick = function(){
                if(this.parentTable.searching == true){
                    var searchBars = [...this.parentTable.node.getElementsByClassName("search_bar")]
                    var beenSorted = []
                    for (let i = 0; i < searchBars.length; i++) {
                        var searchBar = searchBars[i]
                        if(searchBar.children[0]){
                            if(searchBar.children[0].value == ""){
                                beenSorted.push(false)
                            } else {
                                beenSorted.push(true)
                            }
                        }
                    }
                    if(areAll(beenSorted, false)){
                        this.parentTable.filtered = false
                    } else {
                        this.parentTable.filtered = true
                    }
                    
                    if(this.parentTable.filtered){
                        for (let i = 0; i < searchBars.length; i++) {
                            var searchBar = searchBars[i]
                            searchBar.parentElement.getElementsByClassName("rows")[0].innerHTML = ""
                            this.parentTable.headers_data[i].rows = []
                            this.parentTable.headers_data[i].rows_filtered = []
                        }
                        this.parentTable.rows_data_filtered = []
                        var newRows = this.parentTable.rows_data.slice()
                        var offset = 0;
                        for(var i = 0; i < this.parentTable.rows_data.length; i++){
                            var row = this.parentTable.rows_data[i]
                            for (let j = 0; j < this.parentTable.headers_data.length; j++) {
                                var header = this.parentTable.headers_data[j]
                                var searchBar = searchBars[j]
                                if(searchBar.children[0]){
                                    if(searchBar.children[0].value != ""){
                                        if(!row[header["id"]].toString().includes(searchBar.children[0].value)){
                                            newRows.splice(i - offset, 1)
                                            offset++
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                        for(var i = 0; i < newRows.length; i++){
                            this.parentTable.addRowFiltered(newRows[i])
                        }
                    }
                } else {
                    this.parentTable.searching = true
                    var searchBars = this.parentTable.node.getElementsByClassName("search_bar")
                    for (let i = 0; i < searchBars.length; i++) {
                        var searchBar = searchBars[i]
                        searchBar.classList.add("visible")
                    }
                }
                
                this.parentTable.hResizeHeight()

            }
            
        }

        addColumn = function(colInfo){
            this.addColumn_i(colInfo)
        }

        addColumn_i = function(header_data){
            header_data.rows = []
            header_data.rows_filtered = []
            this.headers_data.push(header_data)
            var col = document.createElement("div")
            col.classList.add("col")
            col.style.display = header_data["visible"] ? "inline-block" : "none"
            col["column_id"] = header_data["id"]
            var id = Math.random()
            col.id = id
            header_data["html_id"] = id
            var innerCol = document.createElement("div")
            innerCol.classList.add("innerCol")
            var act_header_info = header_data
            var act_header = document.createElement("div")
            var p_data = document.createElement("p")
            p_data.classList.add("d_data")
            p_data.innerHTML = act_header_info.innerHTML
            act_header.appendChild(p_data)
            act_header.classList.add("hCell")


            var search_div = document.createElement("div")
            search_div.classList.add("search_bar")
            if(header_data["searchable"]){
                var searchInput_bar = document.createElement("input")
                searchInput_bar.classList.add("search_bar_input")
                switch (header_data.type) {
                    case "bool":
                        searchInput_bar.type = "checkbox"
                        searchInput_bar.value = ""
                        searchInput_bar.onclick = function(){
                            this.value = this.checked.toString()
                        }
                        break;
                
                    default:
                        searchInput_bar.type = header_data.type
                        break;
                }
                search_div.appendChild(searchInput_bar)
            }
            if(header_data["sortable"]){
                var sort_html = document.createElement("div")
                sort_html.classList.add("sort")
                var up_sort_html = document.createElement("div")
                up_sort_html.classList.add("sort_up_arrow")
                up_sort_html.classList.add("sort_arrow")
                up_sort_html.innerHTML = "⏶"
                var down_sort_html = document.createElement("div")
                down_sort_html.classList.add("sort_down_arrow")
                down_sort_html.classList.add("sort_arrow")
                down_sort_html.innerHTML = "⏷"
                sort_html.appendChild(up_sort_html)
                sort_html.appendChild(down_sort_html)
                act_header.appendChild(sort_html)
                sort_html["direction"] = "down"
                var clicker = document.createElement("div")
                clicker.classList.add("clicker")
                act_header.appendChild(clicker)
                clicker["this_p"] = this
                clicker.onclick = function(){
                    this["this_p"].sortBy(act_header, header_data)
                }
                if(header_data["sortDefault"]){
                    act_header.classList.add("sort_used")
                    sort_html["direction"] = "up"
                    up_sort_html.classList.add("sort_arrow_used")
                    this.sortedBy = header_data.id
                    this.sortedByHTML = header_data.html_id
                }
            }
            var hResize = document.createElement("div")
            hResize.classList.add("hResize")
            hResize.addEventListener("mousedown", function(e){resizeListener(e)});
            var hRows = document.createElement("div")
            hRows.classList.add("rows")
            innerCol.appendChild(act_header)
            innerCol.appendChild(search_div)
            innerCol.appendChild(hRows)
            col.appendChild(innerCol)
            col.appendChild(hResize)
            this.resizers.push(hResize)
            this.node.appendChild(col)

            setTimeout(() => {
                this.hResizeHeight()
                resizeScrollBar(this.node)
            }, 10);
        }

        hResizeHeight = function(){            
            for(var i = 0; i < this.resizers.length; i++){
                this.resizers[i].classList.add("invisible")
            }
            var height = this.node.getBoundingClientRect().height
            for(var i = 0; i < this.resizers.length; i++){
                this.resizers[i].classList.remove("invisible")
                this.resizers[i].style.height = height + "px"
            }

        }

        addRows = function(rowsInfo){     
            for(var i = 0; i < rowsInfo.length; i++){
                var rowInfo = rowsInfo[i]
                this.rows_data.push(rowInfo)
                this.addRowBack(rowInfo)
            }
            this.tableSort()
        }
        addRow = function(rowInfo){
            this.rows_data.push(rowInfo)
            this.addRowBack(rowInfo)
            this.tableSort()
        }
        addRowFiltered = function(rowInfo){
            this.rows_data_filtered.push(rowInfo)
            this.addRowBack(rowInfo)
            this.tableSort()
        }
        addRowBack = function(rowInfo){
            for(var i = 0; i < this.headers_data.length; i++){
                var actual_header = this.headers_data[i]
                var act_dataCell = document.createElement("div")
                act_dataCell.classList.add("dCell")
                var headerName = actual_header["id"]
                if(rowInfo[headerName] != undefined){
                    var act_data_node

                    switch (actual_header["type"]) {
                        case "bool":
                            act_data_node = document.createElement("input")
                            act_data_node.type = "checkbox"
                            act_data_node.checked = rowInfo[headerName]
                            act_data_node.disabled = true
                            act_data_node.classList.add("d_data")
                            break;
                    
                        default:
                            act_data_node = document.createElement("p")
                            act_data_node.classList.add("d_data")
                            act_data_node.innerHTML = rowInfo[headerName]
                            break;
                    }

                    act_dataCell.append(act_data_node)
                    if(!this.filtered){
                        this.headers_data[i].rows.push(rowInfo[headerName])
                    } else {
                        this.headers_data[i].rows_filtered.push(rowInfo[headerName])
                    }
                } else {
                    if(!this.filtered){
                        this.headers_data[i].rows.push("")
                    } else {
                        this.headers_data[i].rows_filtered.push("")
                    }
                }
                var col = document.getElementById(actual_header["html_id"]).getElementsByClassName("rows")[0]
                col.appendChild(act_dataCell)
            }
            

            this.hResizeHeight()
        }


        setVisible = function(header_id, visible){
            var header
            for(var i = 0; i < this.headers_data.length; i++){
                var act_header_info = this.headers_data[i]
                if(act_header_info["id"] == header_id){
                    header = act_header_info
                }
            }
            header["visible"] = visible
            var header_html = document.getElementById(header["html_id"])
            header_html.style.display = visible ? "inline-block" : "none"
        }

        sortBy = function(target, header_data){
            if(this.node.getElementsByClassName("sort_used")[0]){
                this.node.getElementsByClassName("sort_used")[0].classList.remove("sort_used")
                var arrows_div = target.getElementsByClassName("sort")[0]
                arrows_div["direction"] = arrows_div["direction"] == "down" ? "up" : "down"
                if(arrows_div["direction"] == "down"){
                    arrows_div.children[1].classList.add("sort_arrow_used")
                    arrows_div.children[0].classList.remove("sort_arrow_used")
                } else {
                    arrows_div.children[0].classList.add("sort_arrow_used")
                    arrows_div.children[1].classList.remove("sort_arrow_used")
                }
                target.classList.add("sort_used")
                this.sortedBy = header_data.id
                this.sortedByHTML = header_data.html_id
                this.sortedDirection = arrows_div["direction"]
                this.tableSort()
            }
            
        }

        tableSort = function(){
            var sortIndex
            for(var i = 0; i < this.headers_data.length; i++){
                if(this.sortedBy == this.headers_data[i].id){
                    sortIndex = i
                    break
                }
            }

            this.rows_data = this.rows_data.sort((a, b) => a[this.headers_data[sortIndex].id] - b[this.headers_data[sortIndex].id])

            switch (this.sortedDirection) {
                case "down":
                    this.rows_data.reverse()
                    break;
            
                default:
                    break;
            }

            
            if(!this.filtered){
                for(var i = 0; i < this.headers_data.length; i++){
                    this.headers_data[i].rows = []                
                    var col = document.getElementById(this.headers_data[i].html_id).getElementsByClassName("rows")[0]
                    col.innerHTML = ""
                }

                for(var i = 0; i < this.rows_data.length; i++){
                    this.addRowBack(this.rows_data[i])
                }

            } else {
                for(var i = 0; i < this.headers_data.length; i++){
                    this.headers_data[i].rows = []                
                    var col = document.getElementById(this.headers_data[i].html_id).getElementsByClassName("rows")[0]
                    col.innerHTML = ""
                }

                for(var i = 0; i < this.rows_data_filtered.length; i++){
                    this.addRowBack(this.rows_data_filtered[i])
                }

            }
        }
    }


    var lastPosition = {
        x: 0.00,
        y: 0.00
    }

    var clickOffset = 0
    onmousemove = function(e){
        if(beenClicked){
            if(beenClicked.classList.contains("hResize")){
                var parent = beenClicked.parentElement
                parent["width"] += e.clientX - lastPosition.x
                if(parent["width"] < min_width){
                    parent.style.width = 30 + "px"
                } else {
                    parent.style.width = parent["width"] + "px"
                }
                
                resizeScrollBar(parent.parentElement)
            } else if (beenClicked.classList.contains("tableSliderBar")){
                beenClicked["left"] += (e.clientX - lastPosition.x)
                var scroll
                if(beenClicked["left"] < 0){
                    beenClicked.style.left = 0 + "px"
                    scroll = 0
                } else if(beenClicked["left"] / beenClicked["relation"] > beenClicked.parentElement.parentElement.getElementsByClassName("table")[0].scrollLeftMax){
                    beenClicked.style.left = beenClicked.parentElement.parentElement.getElementsByClassName("table")[0].scrollLeftMax * beenClicked["relation"] + "px"
                    scroll = beenClicked.parentElement.parentElement.getElementsByClassName("table")[0].scrollLeftMax
                } else {
                    beenClicked.style.left = beenClicked["left"] + "px"
                    scroll = beenClicked["left"] / beenClicked["relation"]
                }
                beenClicked.parentElement.parentElement.getElementsByClassName("table")[0].scrollTo(scroll, 0)
            }
            
            lastPosition.x = e.clientX
            lastPosition.y = e.clientY
            
        }
    }
    
    onmouseup = function(){
        beenClicked = undefined
    }

    function resizeListener(e){
        beenClicked = e.target
        lastPosition.x = e.clientX
        lastPosition.y = e.clientY        
        console.log(e.target)
        e.target.parentElement["width"] = e.target.parentElement.getBoundingClientRect().width
    }
    window.onresize = function(){
        var tables = document.getElementsByClassName("table")
        for(var i = 0; i < tables.length; i++){
            var act_table = tables[i]
            resizeScrollBar(act_table)
        }
    }
    function isOverflown(element) {
        return element.scrollWidth > element.parentElement.getBoundingClientRect().width;
    }
    function resizeScrollBar(act_table){

        function recalcScroll(tableSliderBar){
            tableSliderBar["relation"] = tableSliderBar.parentElement.getBoundingClientRect().width / act_table.scrollWidth
            tableSliderBar.style.width = tableSliderBar["relation"] * 100 + "%"
        }

        if(isOverflown(act_table) && act_table.parentElement.getElementsByClassName("tableSlider").length == 0){
            var scrollBar = document.createElement("div")
            scrollBar.classList.add("tableSlider")
            var tableSliderBar = document.createElement("div")
            tableSliderBar.classList.add("tableSliderBar")
            tableSliderBar["left"] = 0;
            tableSliderBar.addEventListener("mousedown", function(e){
                beenClicked = e.target
                lastPosition.x = e.clientX
                lastPosition.y = e.clientY
                clickOffset = (e.clientX - tableSliderBar.getBoundingClientRect().left)
            })
            scrollBar.appendChild(tableSliderBar)
            act_table.parentElement.appendChild(scrollBar)
            recalcScroll(tableSliderBar)
        } else if(isOverflown(act_table) && act_table.parentElement.getElementsByClassName("tableSlider").length == 1){
            var tableSliderBar = act_table.parentElement.getElementsByClassName("tableSliderBar")[0]
            recalcScroll(tableSliderBar)
        } else if(act_table.parentElement.getElementsByClassName("tableSlider").length == 1){
            act_table.parentElement.getElementsByClassName("tableSlider")[0].remove()
        }
    }



    function areAll(arr, bool) {
        return arr.every(element => element === bool);
    }

</script>
<script>
    /*
    *   With db
    
    *   function data_handeler(){
    *   }
    * 
    *   var _table = new table({"data_handeler": data_handeler})
    */
    var table_frame = document.getElementById("table_frame")
    var _table = new table({})
    table_frame.appendChild(_table.node)
    document.body.appendChild(_table.search_button)
    
    _table.addColumn({"innerHTML": "hola", "id": "hola", "visible": true, "sortable": true, "sortDefault": true, "searchable": true, "type": "text"})
    _table.addColumn({"innerHTML": "adios", "id": "adios", "visible": true, "sortable": false, "type": "text", "type": "date", "searchable": true})
    _table.addColumn({"innerHTML": "test", "id": "test", "visible": true, "sortable": true, "type": "bool", "searchable": true})

    var newRows = []
    for(var i = 0; i < 12; i++){
        newRows.push({"hola": Math.random(),"adios": Math.random(), "test": (Math.round(Math.random()) == 1) ? true : false })
    }
    _table.addRows(newRows)

</script>
</html>
